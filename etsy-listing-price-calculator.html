<!DOCTYPE html>
<!--
	Copyright Â© 2025 Justin Ludwig. All rights reserved.
	Licensed under the Business Source License 1.1 (BSL).
	See LICENSE file in the project root for details.
	
	You may not copy, distribute, or use this code commercially
	without explicit permission from the author.
-->
<!--
	style:
	//todo: style the page - make it remind of etsy style, but not so much that it can confuse
	
	data:
	//todo: reword onpage text
	//todo: clean up html formatting
	//todo: proper <head>
	//todo: accessibilty improvements
	
	script:
	//todo: comment js
	//todo: final refactor once inline todos are done
	
	other:
	//todo: break apart style and scripts into own files? it's already going to be decently small, but best practices
	//todo: fill out readme
	//todo: once ready host on github pages
-->	
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Listing Price Calculator for Etsy Sellers</title>
	<style>
		form, aside {display:inline-block;width:49%;vertical-align: top;}
		.no-storage #storage {display: none;}
		#storage-full-warning {display: none;}
		#storage.storage-full #storage-save-field {pointer-events:none; opacity: .5;}
		#storage.storage-full #storage-full-warning {display: block;}
		.saved {background-color: #d0f5d0; transition: background-color 0.5s;}
	</style>
</head>
<body>
	
	<form id="listing-price-calculator">
		<fieldset id="expenses">
			<legend>expenses</legend>
			<p>add the materials you used, as well as different things you'll need for packaging as those costs can add up</p>
			<ul id="expenses-list">
				
				
			</ul>
			<button type="button" onclick="addItem(expensesList);">+add expense</button>
			<div>Total Expenses: $<span id="expenses-total" class="amount-display">0.00</span></div>
		</fieldset>
		
		<fieldset id="labor">
			<legend>labor</legend>
			<p>this will make up your net profit, don't forget to consider things like packaging and admin time. you can also add flat profits you'd like to get for an item.</p>
			<ul id="labor-list">
				
				
			</ul>
			<button type="button" onclick="addItem(laborList);">+add labor type</button>
			<div>Total Labor Cost: $<span id="labor-total" class="amount-display">0.00</span></div>
		</fieldset>
		<br/><br/>
		<div>Product Value: $<span id="value-total" class="amount-display">0.00</span></div>
		
		
	<br/><br/>
		
		
		
		<fieldset>
			<legend>Etsy Fee Calculations</legend>
			<p>The different fees that are applied to an Etsy order are as follows:<br/>
				$0.20 flat listing fee<br/>
				3% of order total (including sales tax) + $0.25 processing fee<br/>
				6.5% of item total (listed price - minus any applied coupons) transaction fee<br/>
				6.5% of shipping label total transaction fee</p>
			<label>Shipping Label Cost Estimate<input type="number" id="shipping-label" step="0.01" placeholder="0.00"></label><br/>
			<label>Sales Tax Estimate<input type="number" id="sales-tax" step="0.01" value="7.52">%</label><span>(while this varies state to state the national average is 7.52%)</span>
		</fieldset>
		
		
		
		
		<fieldset>
			<legend>etsy offsite ad fees</legend>
			
			<label>ad rate<label><input type="radio" name="offsiteAdFee" value="0" checked>0%</label><label><input type="radio" name="offsiteAdFee" value="12">12%</label><label><input type="radio" name="offsiteAdFee" value="15">15%</label></label>
			
			<p>ad fees. etsy will automatically advertise your listing on your behalf across social media and other channels. if someone clicks an ad and makes a purchase from your shop within 30 days a fee will be applied, and you find out that happened sometime later. the percentage will be applied to the total purchase amount, including shipping, minus taxes.</p>
			<p>if you made less than $10,000 in a year, your ad fee will be 15%. you can disable the external advertising to avoid this, however this option is also tied into search results and can severely limit your listings appearing in normal search results.</p>
			<p>if you made more than $10,000 in a year the fee will be 12% and you can not disable the option.</p>
			
		</fieldset>
		<fieldset>
			<legend>income tax</legend>
			<p>they say if you are going to be self employed you should prepare for around 30% tax on your net profits to cover federal and state, and if you're unlucky, city as well</p>
			<label>income tax calculation<label><input type="radio" name="incomeTax" value="ignore" checked>ignore</label><label><input type="radio" name="incomeTax" value="view">view</label><label><input type="radio" name="incomeTax" value="factor">factor</label></label>
			<label>tax rate<input type="number" id="income-tax-rate" step="0.01" value="30.00">%</label>
		</fieldset>
		<small>*i am not a tax accountant and this site can not be used as tax advice*</small>
	</form>
	<aside>
		<h3>testing totals:</h3>
		<div>suggested listing price $<span id="listing-price" class="amount-display">0.00</span></div>
		
		<h4>Estimated Totals:</h4>
		<div>Listing Fee: $<span id="listing-fee-total" class="fee-total">0.20</span></div>
		<div>Processing Fee: $<span id="processing-fee-total" class="fee-total amount-display">0.00</span></div>
		<div>Transaction Fee: $<span id="transaction-fee-total" class="fee-total amount-display">0.00</span></div>
		<div>Shipping Label Fee: $<span id="shipping-label-fee-total" class="fee-total amount-display">0.00</span></div>
		<div>Offsite Ad Fee: $<span id="offsite-ad-fee-total" class="fee-total amount-display">0.00</span></div>
		<div>Fees Total: $<span id="fees-total" class="amount-display">0.00</span></div>
		<br/>
		<div>Set aside for taxes: $<span id="income-tax-total" class="amount-display">0.00</span></div>
		<br/>
		<div>Total paid by customer: $<span id="customer-total" class="amount-display">0.00</span></div>
		<div>Tax paid by customer: $<span id="tax-total" class="amount-display">0.00</span></div>
		<br/>
		<br/>
		
		<form id="quick-calculator">
			<fieldset>
				<legend>quick calculator</legend>
				<p>if you want to just enter a listing price and see an estimate of what you would get in return.</p>
				<label>Listing Price $<input type="number" id="qc-listing-price" step="0.01" placeholder="0.00"></label><br/>
				<div>Estimated Return: $<span id="qc-return" class="amount-display">0.00</span> <p>This will vary based on taxes, shipping, and fees. For a more robust calculation use the full tool.</p></div>
			</fieldset>
		</form>
		<br/>
		<form id="storage">
			<fieldset>
				<legend>save inputs</legend>
				<div id="storage-save-field">
					<label>Product Name <input type="text" id="save-product-name"></label>
					<button type="button" onclick="saveInputs()">Save Product</button>
				</div>
				<div id="storage-full-warning">Storage is full, remove some items to make room.</div>
				<ul id="storage-list">
					
				</ul>
			</fieldset>
		</form>
		<button type="button" onclick="clearInputs()">clear inputs</button>
		
	</aside>
	
	
	
	<script type="text/javascript">
		
		function toCamelCase(str) {
			return str.toLowerCase().replace(/[-_\s]+([a-z])/g, (_, letter) => letter.toUpperCase());
		}
		
		function toKebabCase(str) {
			return str.replace(/[A-Z]/g, letter => '-' + letter.toLowerCase());
		}
		
		//just want true numbers in the inputs
		document.addEventListener('keydown', event => {
			if(event.target.matches('input[type="number"]') && (event.key === 'e' || event.key === 'E' || event.key === '+' || event.key === '-')){
				event.preventDefault();
			}
		});
		
		//force 2 decimal places in number inputs
		document.addEventListener('blur', event => {
			if (!event.target.matches('input[type="number"]')) return;
		
			const raw = event.target.value.trim();
		
			// 0nly format if input is not empty
			if (raw === '') return;
		
			const value = parseFloat(raw);
			if (!isNaN(value)) {
				event.target.value = value.toFixed(2);
			}
		}, true);
				
		const round2 = n => Math.round(n * 100) / 100;
		
		const valueTotalDependencies = ['expensesTotal', 'laborTotal'];
		const feeKeys = Array.from(document.querySelectorAll('.fee-total')).map(el => toCamelCase(el.id));
		const totals = new Proxy({}, {
			get(_, key) {
				const id = toKebabCase(key);
				const el = document.getElementById(id);
				if (el) return parseFloat(el.textContent) || 0;
				return 0;
			},
			set(_, key, value) {
				const id = toKebabCase(key);
				const el = document.getElementById(id);
				if (el) el.textContent = Number(value).toFixed(2);
		
				//automatically recalc valueTotal if needed
				if (valueTotalDependencies.includes(key)) {
					const newValueTotal = valueTotalDependencies.reduce((sum, k) => sum + (totals[k] || 0), 0);
					totals.valueTotal = newValueTotal;
				}
				
				//automatically recalc feesTotal if any individual fee changes
				if (feeKeys.includes(key)) {
					const total = feeKeys.reduce((sum, feeKey) => sum + (totals[feeKey] || 0), 0);
					totals.feesTotal = total;
				}
				
				return true;
			}
		});
		totals.listingFeeTotal = 0.20;
		const processingFeeFlat = 0.25;
		const processingRate = 0.03;
		const transactionRate = .065;
		const shippingLabelInput = document.getElementById('shipping-label');
		const expensesList = document.getElementById('expenses-list');
		const laborList = document.getElementById('labor-list');
		
		const templates = {
			expensesList: `<li>
					<input type="text" placeholder="expense name" value="{{name}}">
					<input type="number" step="0.01" placeholder="0.00" value="{{value}}">
					<button type="button" onclick="removeItem();">-</button>
				</li>`,
			laborList: `<li>
					<input type="text" placeholder="labor name" value="{{name}}">
					<label>hours<input type="number" class="labor-hours" step="0.01" placeholder="0.00" value="{{hours}}"></label>
					<label>rate<input type="number" class="labor-rate" step="0.01" placeholder="0.00" value="{{value}}"></label>
					<span>Subtotal: $<span class="labor-subtotal">0.00</span></span>
					<button type="button" onclick="removeItem();">-</button>
				</li>`,
			storageList: `<li data-key="{{key}}">
						<span>{{name}}</span>
						<button type="button" onclick="loadSavedInput('{{key}}')">load</button>
						<button type="button" onclick="appendInput('{{key}}')">append</button>
						<button type="button" onclick="deleteSavedInput('{{key}}')">delete</button>
					</li>`
		};
		
		
		function addItem(list, replacements = {}, placement = 'append') {
			const templateKey = toCamelCase(list.id);
			const wrapper = document.createElement('div');
			let html = templates[templateKey];
			
			for(const key in replacements){
				const regex = new RegExp(`{{\\s*${key}\\s*}}`, "g");
				html = html.replace(regex, replacements[key]);
			}
			//clean up any other mustaches
			html = html.replace(/{{\s*[\w]+\s*}}/g, '');
			
			wrapper.innerHTML = html;
			const newItem = wrapper.firstElementChild;
			if(placement == 'append'){
				list.append(newItem);
			} else {
				list.prepend(newItem);
			}
			return newItem;
		}
		
		//expenses
		function updateExpensesTotal() {
			totals.expensesTotal = Array.from(expensesList.querySelectorAll('input[type="number"]')).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
		}
		expensesList.addEventListener('input', event => {
			if (event.target.matches('input[type="number"]')) {
				updateExpensesTotal();
			}
		});
		
		//labor
		function updateLaborTotal() {
			const laborItems = Array.from(laborList.querySelectorAll('li'));
			const subtotals = laborItems.map(li => {
				const hours = parseFloat(li.querySelector('.labor-hours')?.value) || 0;
				const rate = parseFloat(li.querySelector('.labor-rate')?.value) || 0;
				return hours * rate;
			});
		
			laborItems.forEach((li, index) => {
				const subtotalDisplay = li.querySelector('.labor-subtotal');
				if (subtotalDisplay) subtotalDisplay.textContent = subtotals[index].toFixed(2);
			});
		
			totals.laborTotal = subtotals.reduce((sum, subtotal) => sum + subtotal, 0);
		}
		laborList.addEventListener('input', event => {
			if (event.target.matches('input[type="number"]')) {
				updateLaborTotal();
			}
		});
		
		function removeItem(){
			const button = event.currentTarget || event.target;
			const listItem = button.closest('li');
			if (!listItem) return;
			listItem.remove();
			updateTotals();
		}
		
		shippingLabelInput.addEventListener('input', () => {
			const shippingCost = parseFloat(shippingLabelInput.value) || 0;
			totals.shippingLabelFeeTotal = round2(shippingCost * 0.065);
		});
		
		//income tax calculations
		let incomeTaxHandler = document.querySelector('input[name="incomeTax"]:checked').value;
		const incomeTaxRadios = document.querySelectorAll('input[name="incomeTax"]');
		incomeTaxRadios.forEach(radio => {
			radio.addEventListener('change', () => {
				incomeTaxHandler = document.querySelector('input[name="incomeTax"]:checked').value;
				calculateListingPrice();
			});
		});
		
		function calculateIncomeTax(){
			const incomeTaxRate = parseFloat((parseFloat(document.getElementById('income-tax-rate').value) / 100).toFixed(4)) || 0;
			const setAside = totals.laborTotal * incomeTaxRate;
			if(incomeTaxHandler !== 'ignore'){
				totals.incomeTaxTotal = setAside;
			} else {
				totals.incomeTaxTotal = 0;
			}
		}
		
		//fee calculations
		let offsiteAdRate = parseFloat(document.querySelector('input[name="offsiteAdFee"]:checked').value) / 100;
		const adFeeRadios = document.querySelectorAll('input[name="offsiteAdFee"]');
		adFeeRadios.forEach(radio => {
			radio.addEventListener('change', () => {
				offsiteAdRate = parseFloat(document.querySelector('input[name="offsiteAdFee"]:checked').value) / 100;
				calculateListingPrice();
			});
		});
		
		function calculateListingPrice(){
			calculateIncomeTax();
			if(totals.valueTotal <= 0){
				totals.listingPrice = 0;
				totals.processingFeeTotal = 0;
				totals.transactionFeeTotal = 0;
				totals.taxTotal = 0;
				totals.customerTotal = 0;
				totals.offsiteAdFeeTotal = 0;
			} else{
				const totalFlatFees = totals.listingFeeTotal + processingFeeFlat;
				let net = totals.valueTotal + (incomeTaxHandler === 'factor' ? totals.incomeTaxTotal : 0);
				const shippingLabel = parseFloat(shippingLabelInput.value) || 0;
				const salesTaxRate = parseFloat((parseFloat(document.getElementById('sales-tax').value) / 100).toFixed(4)) || 0;
				
				const compoundRate = transactionRate + (processingRate * (1 + salesTaxRate)) + offsiteAdRate;
				const denominator = 1 - compoundRate;
				if (denominator > 0) {
					const listingPriceRaw = (net + (shippingLabel * compoundRate) + totalFlatFees) / denominator;
					const listingPrice = Math.ceil(listingPriceRaw * 100) / 100;
					totals.listingPrice = listingPrice;
					
					const subtotal = listingPrice + shippingLabel;
					const transactionFee = round2(listingPrice * transactionRate);
					const tax = round2(subtotal * salesTaxRate);
					const processingFee = round2((subtotal + tax) * processingRate) + processingFeeFlat;
					const offsiteAdFee = round2(subtotal * offsiteAdRate);
					
					totals.processingFeeTotal = processingFee;
					totals.transactionFeeTotal = transactionFee;
					totals.taxTotal = tax;
					totals.customerTotal = (subtotal + tax);
					totals.offsiteAdFeeTotal = offsiteAdFee;
				}
			}
		}
		
		function updateTotals(){
			updateExpensesTotal();
			updateLaborTotal();
			calculateListingPrice();
		}
		
		document.addEventListener('input', event => {
			if (!event.target.matches('input[type="number"]')) return;
			
			if (event.target.closest('#listing-price-calculator')){
				calculateListingPrice();
			} else if(event.target.closest('#quick-calculator')){
				calculateReturn();
			}
		});
		
		function calculateReturn(){
			const qcTax = 1.0752;
			const qcListingPrice = parseFloat(document.getElementById('qc-listing-price').value) || 0;
			const qcProcessingFee = round2((qcListingPrice * qcTax) * processingRate) + processingFeeFlat;
			const qcTransactionFee = round2(qcListingPrice * transactionRate);
			const qcFees = round2(qcProcessingFee + qcTransactionFee + totals.listingFeeTotal);
			
			totals.qcReturn = qcListingPrice - qcFees;
		}
		
		
		//localStorage handlers
		const elpcPrefix = 'elpc_'; //prefix for localStorage items
		
		function isQuotaExceededError(error){
			return (
				error instanceof DOMException &&
				// everything except firefox
				(error.code === 22 || error.name === "QuotaExceededError" ||
				// firefox
				error.code === 1014 || error.name === "NS_ERROR_DOM_QUOTA_REACHED")
			);
		}
		
		function displayStorageError(){
			document.getElementById('storage').classList.add("storage-full");
		}
		
		function isStorageSupported(){
			try {
				if(!localStorage){
					return false;
				}
				const x = '__storage_test__';
				localStorage.setItem(x, x);
				localStorage.removeItem(x);
				return true;
			} catch (error){
				const quotaFull = isQuotaExceededError(error) && localStorage.length > 0;
				if(quotaFull){
					displayStorageError();
				}
				return quotaFull;
			}
		}
		
		function sanitizeInput(value){
			return value.trim().replace(/[<>]/g, '').replace(/\s+/g, ' ');
		}
		
		if(!isStorageSupported()){
			document.body.classList.add("no-storage");
		} else {
			function saveInputs(){
				const saveName = sanitizeInput(document.getElementById('save-product-name').value);
				const keyName = elpcPrefix+toCamelCase(saveName);
				const inputs = {
					name: saveName,
					expenses: {},
					labor: {},
					shipping: shippingLabelInput.value,
					tax: document.getElementById('sales-tax').value,
					adRate: document.querySelector('input[name="offsiteAdFee"]:checked').value,
					taxFactor: incomeTaxHandler,
					taxRate: document.getElementById('income-tax-rate').value,
					timeStamp: Date.now()
				};
				//each of the expenses - has name & value
				let counter = 0;
				expensesList.querySelectorAll('li').forEach(li => {
					const name = sanitizeInput(li.querySelector('input[type="text"]').value);
					const value = li.querySelector('input[type="number"]').value;
					inputs.expenses[counter] = {name: name, value: value};
					counter++;
				});
				
				//each of the labors - has name & hours & value
				counter = 0;
				laborList.querySelectorAll('li').forEach(li => {
					const name = sanitizeInput(li.querySelector('input[type="text"]').value);
					const hours = li.querySelector('.labor-hours').value;
					const value = li.querySelector('.labor-rate').value;
					inputs.labor[counter] = {name: name, hours: hours, value: value};
					counter++;
				});
				
				try {
					localStorage.setItem(keyName, JSON.stringify(inputs));
				} catch (error){
					displayStorageError();
					return false;
				}
				
				let listItem = document.querySelector('#storage-list [data-key="'+keyName+'"]');
				
				if(listItem){
					const parent = document.getElementById('storage-list');
					parent.prepend(listItem);
				} else {
					listItem = addItem(document.getElementById('storage-list'), {name: saveName, key: keyName}, 'prepend');
				}
				
				listItem.classList.add("saved");
				setTimeout(function(){
					listItem.classList.remove("saved");
				}, 1000);
				
			}
			
			function getSavedInputs(){
				const items = {};
				for (let i = 0; i < localStorage.length; i++) {
					const key = localStorage.key(i);
					if (key && key.startsWith(elpcPrefix)) {
						const storageItem = localStorage.getItem(key);
						const inputs = JSON.parse(storageItem);
						items[key] = inputs;
					}
				}
				const entries = Object.entries(items);
				
				entries.sort(([, a], [, b]) => b.timeStamp - a.timeStamp);
				
				entries.forEach(([key, obj]) => {
					addItem(document.getElementById('storage-list'), {name: obj.name, key: key});
				});
				
			}
			getSavedInputs();
			
			
			function clearInputs(){
				expensesList.querySelectorAll('li').forEach(li => li.remove());
				laborList.querySelectorAll('li').forEach(li => li.remove());
				shippingLabelInput.value = '';
				
				//todo: (refactor) i feel like anywhere i have this kind of stuff can be handled better
				document.getElementById('sales-tax').value = 7.52;
				document.getElementById('income-tax-rate').value = (30).toFixed(2);
				document.querySelector('input[name="offsiteAdFee"][value="0"]').checked = true;
				offsiteAdRate = parseFloat(document.querySelector('input[name="offsiteAdFee"]:checked').value) / 100;
				document.querySelector('input[name="incomeTax"][value="ignore"]').checked = true;
				incomeTaxHandler = 'ignore';
				
				updateTotals();
			}
			
			function getSingleInput(key){
				const storageItem = localStorage.getItem(key);
				const inputs = JSON.parse(storageItem);
				
				return inputs;
			}
			
			function getManufacturingCost(inputs){
				Object.entries(inputs.expenses).forEach(([key, obj]) => {
					addItem(expensesList, {name: obj.name, value: obj.value});
				});
				
				Object.entries(inputs.labor).forEach(([key, obj]) => {
					addItem(laborList, {name: obj.name, hours: obj.hours, value: obj.value});
				});
			}
			
			function getIndirectCost(inputs){
				document.getElementById('save-product-name').value = inputs.name;
				shippingLabelInput.value = inputs.shipping;
				document.getElementById('sales-tax').value = inputs.tax;
				document.getElementById('income-tax-rate').value = inputs.taxRate;
				document.querySelector('input[name="offsiteAdFee"][value="'+inputs.adRate+'"]').checked = true;
				offsiteAdRate = parseFloat(document.querySelector('input[name="offsiteAdFee"]:checked').value) / 100;
				document.querySelector('input[name="incomeTax"][value="'+inputs.taxFactor+'"]').checked = true;
				incomeTaxHandler = inputs.taxFactor;
			}
			
			function loadSavedInput(key){
				clearInputs();
				const inputs = getSingleInput(key);
				getIndirectCost(inputs);
				getManufacturingCost(inputs);
				updateTotals();
			}
			
			function appendInput(key){
				const inputs = getSingleInput(key);
				getManufacturingCost(inputs);
				updateTotals();
			}
			
			function deleteSavedInput(key){
				localStorage.removeItem(key);
				document.querySelector('#storage-list [data-key="'+key+'"]').remove();
			}
		}
		
		
	</script>
</body>
</html>